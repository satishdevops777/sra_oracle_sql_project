---
# ------------------------------------------------------------
# Initialize results
# ------------------------------------------------------------
- name: Initialize sql_results
  set_fact:
    sql_results: []

# ------------------------------------------------------------
# 1. Validate queries are SELECT-only
# ------------------------------------------------------------
- name: Validate all SQL queries are SELECT-only
  assert:
    that:
      - item.query is regex("^(?i)select.*")
    fail_msg: "Only SELECT statements are allowed. Invalid query: {{ item.name }}"
  loop: "{{ sql_queries }}"
  loop_control:
    label: "{{ item.name }}"

# ------------------------------------------------------------
# 2. Check sqlplus availability
# ------------------------------------------------------------
- name: Check if sqlplus exists (Linux)
  command: which sqlplus
  register: sqlplus_check
  changed_when: false
  failed_when: sqlplus_check.rc != 0
  when: ansible_os_family != "Windows"

- name: Check if sqlplus exists (Windows)
  win_shell: where sqlplus
  register: sqlplus_check
  changed_when: false
  failed_when: sqlplus_check.rc != 0
  when: ansible_os_family == "Windows"

# ------------------------------------------------------------
# 3. Execute queries
# ------------------------------------------------------------

# ---------- Linux + Docker ----------
- name: Run query (Linux + Docker)
  shell: |
    docker exec -i {{ oracle_container_name }} bash -c "
    sqlplus -S {{ oracle_user }}/{{ oracle_password }}@{{ oracle_service }} <<EOF
    WHENEVER SQLERROR EXIT SQL.SQLCODE
    WHENEVER OSERROR EXIT 9
    SET PAGESIZE 50000
    SET LINESIZE 32767
    SET FEEDBACK OFF
    SET HEADING OFF
    SET TRIMSPOOL ON
    {{ item.query }};
    EXIT;
    EOF
    "
  register: sql_exec_linux
  failed_when: false
  changed_when: false
  when: ansible_os_family != "Windows"
  loop: "{{ sql_queries }}"
  loop_control:
    label: "{{ item.name }}"

# ---------- Windows ----------
- name: Run query (Windows)
  win_shell: |
    sqlplus -S {{ oracle_user }}/{{ oracle_password }}@{{ oracle_host }}:{{ oracle_port }}/{{ oracle_service }} ^
    "WHENEVER SQLERROR EXIT SQL.SQLCODE
     WHENEVER OSERROR EXIT 9
     SET PAGESIZE 50000
     SET LINESIZE 32767
     SET FEEDBACK OFF
     SET HEADING OFF
     SET TRIMSPOOL ON
     {{ item.query }};
     EXIT;"
  register: sql_exec_windows
  failed_when: false
  changed_when: false
  when: ansible_os_family == "Windows"
  loop: "{{ sql_queries }}"
  loop_control:
    label: "{{ item.name }}"

# ------------------------------------------------------------
# 4. Build results (Linux)
# ------------------------------------------------------------
- name: Build sql_results (Linux)
  set_fact:
    sql_results: "{{ sql_results + [ query_result ] }}"
  vars:
    query_failed: >-
      {{
        item.rc != 0
        or (item.stdout is search('ORA-'))
      }}
    query_result:
      name: "{{ item.item.name }}"
      status: "{{ 'FAILED' if query_failed else 'SUCCESS' }}"
      output: >-
        {{
          (
            item.stdout_lines
            | reject('match', '^(Connected to|Disconnected from)')
            | reject('match', '^SQL>')
            | reject('search', 'ORA-')
            | list
            | join('\n')
          )
          if not query_failed else ''
        }}
      error: >-
        {{
          (
            item.stdout_lines
            | select('search', 'ORA-')
            | list
            | join('\n')
          )
          if query_failed else ''
        }}
  loop: "{{ sql_exec_linux.results | default([]) }}"
  loop_control:
    label: "{{ item.item.name }}"
  when: ansible_os_family != "Windows"

# ------------------------------------------------------------
# 5. Build results (Windows)
# ------------------------------------------------------------
- name: Build sql_results (Windows)
  set_fact:
    sql_results: "{{ sql_results + [ query_result ] }}"
  vars:
    query_failed: >-
      {{
        item.rc != 0
        or (item.stdout is search('ORA-'))
      }}
    query_result:
      name: "{{ item.item.name }}"
      status: "{{ 'FAILED' if query_failed else 'SUCCESS' }}"
      output: "{{ item.stdout if not query_failed else '' }}"
      error: "{{ item.stdout if query_failed else '' }}"
  loop: "{{ sql_exec_windows.results | default([]) }}"
  loop_control:
    label: "{{ item.item.name }}"
  when: ansible_os_family == "Windows"

# ------------------------------------------------------------
# 6. Final summary
# ------------------------------------------------------------
- name: Show SQL execution summary
  debug:
    var: sql_results

# ------------------------------------------------------------
# 7. Send aggregated result to ServiceNow (optional)
# ------------------------------------------------------------
- name: Send results to ServiceNow
  uri:
    url: "{{ sn_callback_url }}"
    method: POST
    headers:
      Content-Type: application/json
    body_format: json
    body:
      ritm: "{{ ritm_number }}"
      results: "{{ sql_results }}"
  when: sn_callback_url | default('') | length > 0
